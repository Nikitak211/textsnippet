var fs = require('fs');

function compile(str) {
    var lines = str.split(/\r\n/);
    
    var code = '(function(_){var out = "";function print(str) {out += str;};';
    
    var inPrint = false;
    
    lines.forEach(function (line) {
        if (line.length && line[0] === '.') {
            if (inPrint) {
                code += '");';
                inPrint = false;
            }
            
            var lineOfCode = line.substr(1);
            code += lineOfCode;
        } else {
            if (!inPrint) {
                code += ';print("';
                inPrint = true;
            }
            
            var line = line.replace(/"/g, '\\"')
            
            var matches = line.match(/\$\{[^}]+\}/g);
            if (matches) {
                matches.forEach(function (match) {
                    line = line.replace(match, '"+' + match.substr(2, match.length - 3) + '+"');
                });
            }
            
            code += line + '\\r\\n';
        }
    });
    
    if (inPrint) {
        code += '");';
    }
    
    code += ';return out;})';
    
    return eval(code);
}

function compileFile(fileName) {
    var template = fs.readFileSync(fileName, {
        encoding: 'utf-8',
    });
    return compile(template);
}

function write(fileName, content) {
    fs.writeFileSync(fileName, content);
}

module.exports = {
    compile: compile,
    compileFile: compileFile,
    write: write,
};
